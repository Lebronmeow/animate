<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8086 Instruction Cycle Animation (CMP)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the application */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        
        /* Style for the component boxes */
        .box {
            font-family: 'Roboto Mono', monospace;
            border: 1px solid #374151; /* border-gray-700 */
            border-radius: 0.5rem; /* rounded-lg */
            background-color: #1F2937; /* bg-gray-800 */
            color: #F9FAFB; /* text-gray-50 */
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
            padding-top: 2rem; /* space for the label */
            text-align: center;
        }

        /* Label for each component box */
        .box::before {
            content: attr(data-label);
            position: absolute;
            top: 0.5rem;
            left: 0.75rem;
            font-size: 0.8rem;
            font-family: 'Inter', sans-serif;
            color: #9CA3AF; /* text-gray-400 */
        }
        
        /* Highlight style for active boxes */
        .box.active {
            background-color: #374151; /* bg-gray-700 */
            border-color: #3B82F6; /* border-blue-500 */
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        /* Styles for SVG arrows */
        .arrow {
            stroke: #4B5563; /* stroke-gray-600 */
            stroke-width: 2.5;
            fill: none;
            opacity: 0.5;
            transition: all 0.4s ease-in-out;
        }
        
        .arrow.active {
            stroke: #3B82F6; /* stroke-blue-500 */
            opacity: 1;
            stroke-width: 4;
        }

    </style>
</head>
<body class="text-white antialiased">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header Section -->
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold tracking-tight text-gray-100">8086 Instruction Cycle</h1>
            <p class="mt-2 text-lg text-gray-400">Animation for <code class="bg-gray-700 px-2 py-1 rounded-md text-blue-400">CMP R1, R2</code></p>
        </div>

        <!-- Controls Section -->
        <div class="flex flex-wrap justify-center items-center gap-4 mb-8 p-4 bg-gray-800 rounded-xl border border-gray-700 shadow-lg">
            <div class="flex items-center gap-2">
                <label for="r1" class="font-medium text-gray-300">R1 Value:</label>
                <input type="number" id="r1" value="14" class="w-24 bg-gray-900 border border-gray-600 rounded-md p-2 text-center text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div class="flex items-center gap-2">
                <label for="r2" class="font-medium text-gray-300">R2 Value:</label>
                <input type="number" id="r2" value="5" class="w-24 bg-gray-900 border border-gray-600 rounded-md p-2 text-center text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <button id="runButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-transform transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed disabled:scale-100">
                Run Simulation
            </button>
        </div>
        
        <!-- Main Datapath Visualization -->
        <div class="relative">
            <!-- Grid for CPU Components -->
            <div id="grid-container" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div id="PC" class="box" data-label="PC">0x100</div>
                <div id="MAR" class="box" data-label="MAR">...</div>
                <div id="MDR" class="box" data-label="MDR">...</div>
                <div id="IR" class="box" data-label="IR">...</div>
                <div id="R1" class="box" data-label="R1">14</div>
                <div id="R2" class="box" data-label="R2">5</div>
                <div id="R3" class="box" data-label="R3 (Flags)">...</div>
                <div id="Y" class="box" data-label="Y">...</div>
                <div id="Z" class="box" data-label="Z">...</div>
                <div id="ALU" class="box col-span-2 md:col-start-2 md:col-span-2" data-label="ALU">...</div>
            </div>

            <!-- SVG Overlay for Arrows -->
            <svg id="svg-arrows" class="absolute top-0 left-0 w-full h-full pointer-events-none">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="8" refY="3.5" orient="auto" markerUnits="strokeWidth">
                        <polygon points="0 0, 10 3.5, 0 7" class="fill-current text-blue-500" />
                    </marker>
                </defs>
                <!-- Arrow Paths will be added here by JS -->
            </svg>
        </div>

        <!-- Message Bar -->
        <div id="message" class="mt-8 text-center bg-gray-800 border border-gray-700 p-4 rounded-xl shadow-lg min-h-[50px] flex items-center justify-center">
            <p class="text-gray-300">Enter values for R1 and R2 and click "Run Simulation".</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const r1Input = document.getElementById('r1');
            const r2Input = document.getElementById('r2');
            const runButton = document.getElementById('runButton');
            const messageEl = document.getElementById('message');
            const svgContainer = document.getElementById('svg-arrows');
            const gridContainer = document.getElementById('grid-container');

            // --- Component Box References ---
            const boxes = {
                PC: document.getElementById('PC'),
                MAR: document.getElementById('MAR'),
                MDR: document.getElementById('MDR'),
                IR: document.getElementById('IR'),
                R1: document.getElementById('R1'),
                R2: document.getElementById('R2'),
                R3: document.getElementById('R3'),
                Y: document.getElementById('Y'),
                Z: document.getElementById('Z'),
                ALU: document.getElementById('ALU'),
            };

            const ANIMATION_SPEED = 1200; // ms per step
            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // --- Arrow Definitions ---
            const arrowDefs = [
                { id: 'pc-mar', from: 'PC', to: 'MAR' },
                { id: 'mar-mdr', from: 'MAR', to: 'MDR' },
                { id: 'mdr-ir', from: 'MDR', to: 'IR' },
                { id: 'r1-y', from: 'R1', to: 'Y' },
                { id: 'r2-alu', from: 'R2', to: 'ALU' },
                { id: 'y-alu', from: 'Y', to: 'ALU' },
                { id: 'alu-z', from: 'ALU', to: 'Z' },
                { id: 'z-r3', from: 'Z', to: 'R3' },
            ];
            
            // --- Dynamic Arrow Drawing ---
            function drawArrows() {
                svgContainer.innerHTML = `
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="8" refY="3.5" orient="auto" markerUnits="strokeWidth">
                            <polygon points="0 0, 10 3.5, 0 7" class="fill-current text-blue-500" />
                        </marker>
                    </defs>
                `; // Clear existing arrows
                const gridRect = gridContainer.getBoundingClientRect();

                arrowDefs.forEach(def => {
                    const fromEl = boxes[def.from];
                    const toEl = boxes[def.to];
                    const fromRect = fromEl.getBoundingClientRect();
                    const toRect = toEl.getBoundingClientRect();

                    const startX = (fromRect.left + fromRect.width / 2) - gridRect.left;
                    const startY = (fromRect.top + fromRect.height / 2) - gridRect.top;
                    const endX = (toRect.left + toRect.width / 2) - gridRect.left;
                    const endY = (toRect.top + toRect.height / 2) - gridRect.top;
                    
                    const cx = (startX + endX) / 2 + (startY - endY) * 0.2;
                    const cy = (startY + endY) / 2 + (endX - startX) * 0.2;

                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('id', `arrow-${def.id}`);
                    path.setAttribute('class', 'arrow');
                    path.setAttribute('d', `M${startX},${startY} Q${cx},${cy} ${endX},${endY}`);
                    path.setAttribute('marker-end', 'url(#arrowhead)');
                    svgContainer.appendChild(path);
                });
            }

            drawArrows();
            window.addEventListener('resize', drawArrows);

            // --- Reset Function ---
            function resetState() {
                Object.values(boxes).forEach(box => {
                    box.textContent = '...';
                    box.classList.remove('active');
                });
                document.querySelectorAll('.arrow').forEach(arrow => arrow.classList.remove('active'));

                const r1Val = r1Input.value || 0;
                const r2Val = r2Input.value || 0;
                boxes.R1.textContent = r1Val;
                boxes.R2.textContent = r2Val;
                boxes.R3.textContent = '...';
                boxes.PC.textContent = '0x100';
                messageEl.firstElementChild.textContent = 'Ready for simulation.';
            }
            
            resetState();
            r1Input.addEventListener('input', resetState);
            r2Input.addEventListener('input', resetState);

            // --- Animation Step Helper ---
            async function animateStep(config) {
                const { message, from, to, arrow, value, target } = config;
                
                messageEl.firstElementChild.textContent = message;
                if (arrow) document.getElementById(`arrow-${arrow}`)?.classList.add('active');
                if (from) boxes[from].classList.add('active');
                
                await sleep(ANIMATION_SPEED / 2);

                if (to) {
                    boxes[to].classList.add('active');
                    if (value !== undefined) {
                         boxes[target || to].textContent = value;
                    }
                }
                
                await sleep(ANIMATION_SPEED / 2);

                if (arrow) document.getElementById(`arrow-${arrow}`)?.classList.remove('active');
                if (from) boxes[from].classList.remove('active');
                if (to) boxes[to].classList.remove('active');
            }

            // --- Main Simulation Logic ---
            runButton.addEventListener('click', async () => {
                runButton.disabled = true;
                resetState();
                await sleep(500);

                const r1Val = parseInt(r1Input.value, 10) || 0;
                const r2Val = parseInt(r2Input.value, 10) || 0;
                const pcVal = boxes.PC.textContent;

                // --- 1. Fetch Cycle ---
                await animateStep({ message: 'FETCH: PC value (address of instruction) is moved to MAR.', from: 'PC', to: 'MAR', arrow: 'pc-mar', value: pcVal });
                await animateStep({ message: 'FETCH: Instruction is fetched from memory into MDR.', from: 'MAR', to: 'MDR', arrow: 'mar-mdr', value: 'CMP R1,R2' });
                await animateStep({ message: 'FETCH: Instruction moves from MDR to the Instruction Register (IR).', from: 'MDR', to: 'IR', arrow: 'mdr-ir', value: 'CMP R1,R2' });

                // --- 2. Decode Cycle ---
                messageEl.firstElementChild.textContent = 'DECODE: Control Unit decodes the CMP instruction.';
                boxes.IR.classList.add('active');
                await sleep(ANIMATION_SPEED);
                boxes.IR.classList.remove('active');

                // --- 3. Execute Cycle ---
                await animateStep({ message: 'EXECUTE: First operand from R1 moves to temporary register Y.', from: 'R1', to: 'Y', arrow: 'r1-y', value: r1Val });
                await animateStep({ message: 'EXECUTE: Second operand from R2 and value from Y move to ALU.', from: 'R2', to: 'ALU', arrow: 'r2-alu' });
                boxes.Y.classList.add('active');
                document.getElementById('arrow-y-alu').classList.add('active');

                messageEl.firstElementChild.textContent = 'EXECUTE: ALU performs subtraction (R1 - R2) to compare.';
                await sleep(ANIMATION_SPEED / 2);

                const result = r1Val - r2Val;
                boxes.ALU.textContent = result;
                
                await sleep(ANIMATION_SPEED / 2);
                boxes.Y.classList.remove('active');
                document.getElementById('arrow-y-alu').classList.remove('active');

                // --- 4. Write Back Cycle (Flags update) ---
                await animateStep({ message: 'EXECUTE: Subtraction result moves to temporary register Z.', from: 'ALU', to: 'Z', arrow: 'alu-z', value: result });

                let flagBoxValue = "R1 > R2";
                let flagMessage = "Flags set: R1 > R2 (ZF=0, SF=0)";
                if (result === 0) {
                    flagBoxValue = "R1 = R2";
                    flagMessage = "Flags set: R1 = R2 (ZF=1)";
                } else if (result < 0) {
                    flagBoxValue = "R1 < R2";
                    flagMessage = "Flags set: R1 < R2 (SF=1)";
                }
                
                await animateStep({ message: `WRITE BACK: Result is discarded. ${flagMessage}`, from: 'Z', to: 'R3', arrow: 'z-r3', value: flagBoxValue });
                
                // --- 5. Increment PC ---
                messageEl.firstElementChild.textContent = 'PC is incremented to point to the next instruction.';
                boxes.PC.classList.add('active');
                await sleep(ANIMATION_SPEED/2);
                boxes.PC.textContent = '0x104';
                await sleep(ANIMATION_SPEED/2);
                boxes.PC.classList.remove('active');

                messageEl.firstElementChild.textContent = 'Execution Completed!';
                runButton.disabled = false;
            });
        });
    </script>

</body>
</html>

